// Request for passports
new Promise(resolve => resolve(
	{"response":[["Гусь","Обыкновенный","М",0,"Гусь",454704688,"19.06.2005","22.04.2021","https://sun9-41.userapi.com/impg/7OZR5nLj6QlkhHtwYM3t0RpoFQTpL1xxKwqwnw/ulJLvTYWB2I.jpg?size=1000x1000&quality=96&sign=1f5243fb9c4b108d242bbafc78caee5e",1,[["29.07.2022","Илья Марцинкевичъ",0]]],["Никита","Соколовский","М",0,"Сокол",383251973,"09.09.2019","07.01.2021","",1,""],["Илья","Марцинкевичъ","М",0,"Гусь",313545237,"14.05.1988","07.01.2021","",-1,[["29.07.2022","Гусь Обыкновенный",0]]],["Захар","Тигиев","М",0,"Гусь",515619004,"22.08.2000","07.01.2021","",1,""],["Михаил","Шадрин","М",1,"Гусь",237918893,"09.05.1945","07.01.2021","",1,""],["Андрей","Чернов-Кропоткин","М",2,"Утка",215956492,"01.01.0001","22.04.2021","https://sun9-51.userapi.com/impg/SlSDiHel965LZ8AQog4WIfYEeqhjoWrsHoOldQ/enBG3UUUauE.jpg?size=1280x720&quality=96&sign=e80ec89751ebc550278827530026bfe1",1,""],["Екатерина","Берёзова","Ж",0,"Сумишка",617159849,"09.02.2004","07.01.2021","",1,""],["Артём","Гоман","М",0,"Гусь",307017223,"28.07.1939","07.01.2021","",1,""],["Серджо","Гуслинг","М",1,"Гусь",369333598,"07.06.2005","09.01.2021","",1,""],["Илья","Голополосов","М",2,"Утка",439540079,"19.03.1978","24.04.2021","https://sun9-32.userapi.com/impg/DOkSJufMErbgdxCVocr_cQcsSAbnFezAAQcEHQ/fqNZ8QgV6Rg.jpg?size=1019x720&quality=96&sign=a2490dfaefc6c7fbcc85ad3006fc323f&type=album",1,""],["Влад","Калыхан","М",0,"Гусь",450593895,"07.01.-0001","08.01.2021","",1,""],["Сергей","Рыбокур","М",0,"Гусь",546962618,"17.06.2001","11.01.2021","",1,""],["Руслан","Гиндуллин","М",2,"Утка",223326640,"28.05.2018","12.01.2021","",1,""],["Михаил","Моисеев","М",0,"Гусь",540507817,"02.10.2000","12.01.2021","",1,""],["Кот","Жирный","М",0,"Гусь",602214230,"26.11.1996","13.01.2021","",1,""],["Михаил","Степанов","М",0,"Гусь",600037865,"18.07.1800","13.01.2021","",1,""],["Михаил","Моисеев","М",0,"Гусь",540507817,"02.10.2000","17.01.2021","",1,""],["Андрей","Панюшев","М",0,"Гусь",329480377,"01.01.2000","17.01.2021","",1,""],["Андрей","Леонтьев","М",2,"Утка",584391172,"10.06.2000","17.01.2021","",1,""],["Артём","Балчиков","М",2,"Утка",210843864,"32.12.2222","17.01.2021","",1,""],["Алексей","Пирожок","М",0,"Гусь",233366201,"11.09.2001","17.01.2021","",1,""],["Диана","Афанасьева","Ж",1,"Гусь",520532233,"21.06.1812","17.01.2021","",1,""],["Александр","Шадских","М",0,"Блин",375359798,"12.05.2017","17.01.2021","",1,""],["Мариам","Сафаров","М",0,"Гусь",569270836,"06.02.1992","18.01.2021","",1,""],["Павел","Михайленко","М",0,"Гусь",505270954,"07.07.2005","18.01.2021","",1,""],["Михаил","Морозов","М",0,"Гусь",551951523,"01.16.1999","20.01.2021","",1,""],["Леон","Данилочкин","М",0,"Башкир",464835384,"23.03.1907","24.01.2021","",1,""],["Владимир","Чернов","М",0,"Гусь",602404004,"04.05.2000","24.01.2021","",1,""],["Николай","Романов - Чайка","М",2,"Пидорас",589593463,"07.01.2021","24.01.2021","",1,""],["Коннор","Из-Детройта","М",0,"Гусь",540538592,"01.01.1209","25.01.2021","",1,""],["Дмитрий","Шутов","М",0,"Гусь",285288441,"27.11.1996","06.02.2021","",1,""],["Николай","Гаманов","М",0,"Гусь",610681580,"04.09.2006","08.02.2021","",1,""],["Гусь","Серебряный","М",0,"Гусь",552160385,"18.08.2077","09.02.2021","",1,""],["Рома","Никитин","М",0,"Гусь",481222865,"13.10.1980","12.02.2021","",1,""],["Кто","То","М",2,"Утка",510527795,"36.16.7824","12.02.2021","",1,""],["Михаил","Аладушкин","М",2,"Утка",578947601,"18.03.2021","24.04.2021","https://sun9-59.userapi.com/impg/dkty_-qLRDH8m7ai2LZftlRIFTofufuwZEuGLQ/frI1FLIv7s8.jpg?size=503x567&quality=96&sign=656c77ab830739c904741159678f778c",1,""],["Богдан","Богданыч","М",2,"Утка",566864213,"00.00.0000","13.02.2021","",1,""],["Гарик","Солдатов","М",0,"Гусь",600737877,"06.05.2000","15.02.2021","",1,""],["Михаил","Темнов","М",0,"Гусь",493110292,"01.04.1993","16.02.2021","",1,""],["Александр","Свешников","М",0,"Кот",611757082,"01.04.2009","20.03.2021","",1,""],["Марквин","Блюстар","М",0,"Гусь",614664652,"16.07.2005","21.03.2021","",1,""],["Кирилл","Шмидтов","М",1,"Кот",605257171,"00.00.0000","24.03.2021","",1,""],["Гусь","Тарталья - Чайлд","М",0,"Гусь",556751813,"01.01.0000","24.04.2021","https://sun9-67.userapi.com/impg/s0fax6c90wE6fByUY2ZKa1NG2RJ-PxzwXZTZiw/dfD_v5hkMO0.jpg?size=1030x1080&quality=96&sign=85a06b59c785fd11c6e1cc02211a3145",1,""],["Альберт","Куйбышев","М",0,"Гусь",518482046,"23.08.1997","11.04.2021","",1,""],["Кирилл","Асташенко","М",0,"Гусь",251044329,"02.11.1943","11.04.2021","",1,""],["Алексей","Черкашин","М",0,"Гусь",319747653,"09.04.2000","13.04.2021","",1,""],["Ашот","Аванянович","М",0,"Чурка",469713653,"17.05.2008","18.04.2021","",1,""],["Хлебиэссо","Утианус","М",2,"Таджик",402470792,"21.09.2006","19.04.2021","",1,""],["Павел","Тремасов","М",0,"Кот",534090415,"27.09.1759","20.04.2021","",1,""],["Илья","Бронштейн","М",0,"Гусь",581285743,"23.06.2000","20.04.2021","",1,""],["Иван","Иванов","М",2,"Утка",607196993,"09.04.1337","22.04.2021","",1,""],["Алина","Пряникова","Ж",2,"Утка",230359609,"02.08.2000","22.04.2021","",1,""],["Матвей","Смольников ","М",2,"Гусь",394152248,"01.11.2005","22.04.2021","",1,""],["Саня","Андреев","М",2,"Утка",575712727,"23.11.2006","23.04.2021","",1,""],["Александр ","Кондратьев","М",2,"Утка",362130993,"15.12.2004","24.04.2021","https://sun9-28.userapi.com/impg/6q_lWIRN_K3AdchiI-4hvlQSbLx9730-bpnoTQ/xuQmMQVQASI.jpg?size=1040x1080&quality=96&sign=fd6d350545c7658db20d09d3e3fb8488&type=album",1,""],["Виктор","Металлов","М",0,"Гусь",586307908,"20.10.1901","29.04.2021","https://ya.cc/t/1lm679pN3BLSXF",1,""],["Александр ","Панов","М",0,"Крейсер \"аврора\"",154196945,"26.09.2002","06.05.2021","https://i007.fotocdn.net/s117/d9e0e96fea03d04f/public_pin_l/2655688464.jpg",1,""],["Илья ","Сорокопудов ","М",1,"Грокс",269309461,"06.08.1865","06.05.2021","",1,""],["Даниил","Эверетт","М",2,"Утка",562179075,"19.05.2000","08.05.2021","",1,""],["Вероника","Снейп","М",2,"Утка",392498426,"04.02.2000","08.05.2021","https://i.pinimg.com/564x/07/66/a0/0766a0fd5ac86dd49a3a99ab25224e39.jpg",1,""],["Артур","Никакович","М",0,"Кот",504320643,"20.02.2007","09.05.2021","https://sun9-38.userapi.com/impg/Soq4AIXbv8JrzENvdK8ny0j846GT-vuZwCJXnw/IQL1mQS_ph8.jpg?size=570x759&quality=96&sign=e68c12260d707c8550f0cf72fad928c9",1,""],["Никита ","Виленский","М",0,"Гусь",243199055,"22.05.1821","22.05.2021","https://sun9-15.userapi.com/impg/ROW8mj249IADemCw01bSHCiRVVBmnnHzdb4BAQ/ggzjQC0X_Ww.jpg?size=828x1036&quality=96&sign=80defbf4c1e80dd51348f2b302e0b8d2",1,""],["Андрей","Белов","М",0,"Кот",374082949,"09.09.1999","24.05.2021","",1,""],["Евгений","Хорошавин","М",0,"Гусь",637438815,"07.12.2005","25.05.2021","",1,""],["Филипп","Исаев ","М",0,"Ворон",562408432,"31.05.2007","26.05.2021","https://im0-tub-ru.yandex.net/i?id=34f76629a5512baf5d2cb17f217b4400-l&n=13",1,""],["Тигран","Куколдович","М",0,"Гусь",610655813,"27.05.2021","27.05.2021","",1,""],["Джейсон","Фокс","М",0,"Лис",454559827,"18.04.2002","27.05.2021","https://sun9-16.userapi.com/impg/prOO7GpbYQLAdxXVp1OAhX1-4AkFGQWJKm3TmQ/BrY1Z89WSqI.jpg?size=500x500&quality=96&sign=2170bbe8bc444b296b48ca1154ed47de",1,""],["Олег","Волков","М",0,"Волк",519181044,"09.11.1963","28.05.2021","https://avatars.mds.yandex.net/get-zen_doc/1542122/pub_60cf07ce92badd3b0fa21577_60cf0afcb4fa37737690245c/scale_1200",1,""],["Андрей","Марыскин","М",0,"Гусь",399366577,"04.02.1972","30.05.2021","https://cs9.pikabu.ru/post_img/big/2017/03/12/11/1489342618163949569.jpg",1,""],["Роман","Игнатов","М",0,"Украинец",603420562,"29.11.1999","08.06.2021","",1,""],["Ин","Лала","М",2,"Утка",652921238,"11.11.0004","26.06.2021","",1,""],["Богдан","Толкачёв","М",0,"Беларус",307226056,"21.09.2005","30.06.2021","",1,""],["Николай","Гусьмернов","М",0,"Гусь",533481452,"16.06.2000","02.07.2021","https://i.ibb.co/JFGvvdk/image-1.png",1,""],["Георгий","Перский","М",0,"Гусь",546214593,"15.07.2001","22.08.2021","",1,""],["Чебурек","Афанасьевич","М",0,"Чебурек",591041004,"19.10.1999","22.08.2021","https://sun9-30.userapi.com/impg/RTlhg9TI3SMf7AqIBjY1IYvAP4FEZFzKZZDHIA/uvgyn2iS_Bc.jpg?size=902x1280&quality=95&sign=2e450f8985ef922ac7d3453ade5512ed&type=album",1,""],["Ведомор","Щучич","М",0,"Гусь",243465659,"17.02.1971","22.08.2021","https://sun9-57.userapi.com/agVfzAXZli4knluU66yAEaw66bdObYhgUqev3w/oGxFDIeIvPM.jpg",1,""],["Дионис","Карпентер","М",0,"Гусь",634204358,"01.01.1937","22.08.2021","",1,""],["Афанасий ","Жатецкий","М",0,"Гусь",445789326,"12.02.1975","22.08.2021","",1,""],["Максим ","Краевой ","М",0,"Каратышка",341430424,"16.03.1999","23.08.2021","https://sun9-20.userapi.com/impg/cqGhuj10TGw-a9zkdTeZVX1luEWwqCkw64j7Eg/WM0XOkALadM.jpg?size=918x904&quality=96&sign=dfed9df20136aae278f2056b0bc65d4e",1,""],["Вильгельм","фон Шескопф","М",0,"Гусь",513834989,"29.05.1897","19.09.2021","",1,""],["Штрац","Вассерман ","М",0,"Гусь",483871456,"24.08.1991","19.09.2021","",1,""],["Брезан","Гусина","Ж",0,"Гусь",354894377,"10.02.1979","19.09.2021","https://ic.wampi.ru/2021/08/27/Screenshot_20210827-145110.png",1,""],["Иван","Архаров ","М",0,"Гусь",597147588,"19.04.2002","19.09.2021","",1,""],["Кирилл","Галамай","М",1,"Гусь",644984314,"15.02.2007","25.09.2021","https://sun9-25.userapi.com/impg/WRmCGoDocvBVebOCBH5YriBkCCLJCitEgnCdBA/WtgFHL2Xu24.jpg?size=1280x720&quality=96&sign=79d7ba780f998bc80c84303955dce119",1,""],["Dmitry","GoodHobbit","М",0,"Гусь",48386389,"07.10.1989","26.09.2021","",1,""],["Гусь","Выбирусь","М",1,"Убер Снягір","Н/Д","08.08.1988","17.12.2021","https://static.wikia.nocookie.net/adventuretime/images/2/2c/ChooseGoose3.png/revision/latest/scale-to-width-down/185?cb=20131108105400&path-prefix=ru",1,""],["Мучачос","Начосович","М",0,"Гусь",610655813,"22.12.2021","21.12.2021","","",""],["Джэня ","Бацян ","М",0,"Гусь",321312340,"23.03.2033","06.01.2022","",1,""],["Олежа","Цой","М",2,"Утка",662791994,"27.03.2000","08.01.2022","https://sun9-79.userapi.com/impg/GS_8VWxsGYiRhMb7ubMUFDd-NKZXf3hUd-jY7g/xeGRbDMuKVk.jpg?size=1080x1080&quality=95&sign=c13bd7239847d8e66b61600b5eee2b5d",1,""],["Сергей","Гусев","Оптимус прайм",0,"Гусь",492655224,"29.03.2003","20.01.2022","https://ie.wampi.ru/2022/01/20/imageeb27c56ece53ada9.png",1,""],["Shipuchka","Bimta","М",1,"Кот",645036314,"06.05.2000","24.01.2022","https://i.ytimg.com/vi/9QvxMWlf87Y/maxresdefault_live.jpg",1,""],["Альберт","Голиков","М",1,"Гусь",48386389,"02.11.2006","29.01.2022","",1,""],["Санс","Эпик","М",1,"Кот",577358978,"22.10.1987","29.01.2022","https://vk.com/photo577358978_457249776",1,""],["Міхась","Бакуменка","М",0,"Гусь",657128539,"25.08.2006","05.03.2022","",1,""],["Алекс","Грёгер","М",0,"Гусь",391599014,"20.01.2005","13.06.2022","",1,""],["Илья","Гус-Манн","М",0,"Гусь",575772222,"18.08.1962","27.06.2022","",1,""]]}
))
.then(({response}) => {
	passports = response;
	body.classList.remove('loading');
	idInput.max = passports.length;
	if (currPassportId) {
		idInput.value = currPassportId;
		toHtml(passports[currPassportId-1]);
	};
	console.log('Passports have been loaded');
});

let passports, currCountry, colorChanging;
let currPassportId = +location.search.split('id=')[1] || null;
let currLoc = 1;

const {protocol, host, pathname} = location;
const BASE_URL = protocol + "//" + host + pathname;
const FILES_PATH = './files/';
const getPassportUrl = id => id ? BASE_URL + '?id=' + id : BASE_URL;
const DEFAULT_COLOR = 'rgb(135, 135, 135)';

const $ = id => document.getElementById(id);
const transformBtns = num => {
	prevBtn.style.transform = `translateX(-${num}px)`;
	nextBtn.style.transform = `translateX(${num}px)`;
};

// DOM-elements
const {body} = document;
const spreads = Array.from(body.querySelectorAll('.spread'));
const rotateBtn = $('rotate-btn');
const prevBtn = $('prev');
const nextBtn = $('next');
const idBtn = $('id-btn');
const idForm = $('id-form');
const idInput = $('id-input');
const book = $('book');
const osisLogo = $('osis');

const createGetter = (prefix) => ({
	get: (target, name) => target.querySelector(prefix + name)
});
const proxyDOM = (obj) => new Proxy(obj, {
	set: (target, name, value) => target[name].textContent = value
});

const u = new Proxy($('f3'), createGetter('#u_'));
const mainPage = proxyDOM({
	name: u.name,
	flagCont: u['flag-container'],
	flag: u.flag,
	country: u.country,
	photo: u.photo,
	id: u.id,
	surname: u.surname,
	dob: u.DoB,
	doi: u.DoI,
	sex: u.sex,
	nationality: u.nationality,
	print: u.print,
});

const cah = new Proxy($('country_and_herb'), createGetter('#'));
const frontCover = proxyDOM({
	countryName: cah['country-name'],
	herb: cah.herb,
});

const countries = [
	['gsld', '#332266', 'Республика Гусляндия', 'goose.svg'],
	['ngld', '#55bb33', 'Республика Неогусляндия', 'goose.svg'],
	['duck', '#ee8844', 'Утиное Государство', 'duck.png']
].map(([code, colorHEX, name, stdImg]) => ({
	code, name, colorHEX,
	color: colorHEX.slice(1).match(/../g).map(num => parseInt(num, 16)),
	dir: FILES_PATH + code + '/',
	standardImage: FILES_PATH + 'standard-image/' + stdImg
}));

const qr = Object.assign(new QRCode($('qr'), {
	text: getPassportUrl(currPassportId),
	width: 256,
	height: 256,
	colorDark : DEFAULT_COLOR,
	colorLight : '#00000000',
	correctLevel : QRCode.CorrectLevel.L
}), {
	startColorChanging() {
		this._oDrawing._elCanvas.style.display = 'unset';
		this._oDrawing._elImage.style.display = 'none';
		return {
			changeQRColor: color => {
				this._htOption.colorDark = color;
				this._oDrawing.draw(this._oQRCode);
			},
			stopQRColorChanging: () => {
				this.makeImage();
			}
		};
	}
});

// Set page positions & cover color
for (let i = 0; i < spreads.length; i++) {
	spreads[i].style.zIndex = spreads.length - i;
};
body.style.setProperty('--p_color', DEFAULT_COLOR);

const [lSpread, plSpread] = spreads.reverse();
const [fSpread, sSpread] = spreads.reverse();
fSpread.isCover = fSpread.isFirst =
lSpread.isCover =
sSpread.isExtreme = sSpread.isFirst =
plSpread.isExtreme = true;

const maxLoc = spreads.length + 1;

function getPassport() {
	const id = +idInput.value;
	if (
		id > 0 &&
		id !== currPassportId
	) {
		currPassportId = id;
		history.pushState({id: currPassportId}, null,
			getPassportUrl(currPassportId)
		);
		qr.makeCode(getPassportUrl(currPassportId));
		toHtml(passports[currPassportId-1]);
	};
}

onpopstate = ({state}) => {
	const id = state?.id || false;
	if (id) {
		idInput.value = currPassportId = id;
		toHtml(passports[id-1]);
	} else location.reload();
};

mainPage.photo.onerror = ({target: el}) => el.src = currCountry.standardImage;
function toHtml(data) {
	const [name, surname, sex, countryId, nationality, id, dob, doi, photoUrl, passportStatus, marriages] = data;
	const country = countries[countryId];
	if (currCountry !== country) {
		const is = {
			[country.code.toUpperCase()]: true
		};
		const herbUrl = country.dir + '/herb.svg';
		frontCover.countryName.style.fontSize = (is.NGLD ? '20' : '24') + 'px';
		frontCover.countryName = country.name;
		frontCover.herb.src = herbUrl;
		changeColor(
			getComputedStyle(body).getPropertyValue('--p_color'),
			country.color
		);
		book.style.setProperty('--herb_url', `url(${herbUrl})`);
		currCountry = country;

		mainPage.flagCont.style = is.DUCK
			? 'text-align: center; background: #8ce; width: 80%'
			: 'text-align: none; background: none; width: none';
		Object.assign(mainPage.flag, {
			src: is.DUCK
				? herbUrl
				: country.dir + '/flag.svg',
			style: `float: ${is.DUCK ? 'none' : 'left'}`
		});
		mainPage.country = country.name;
	};
	mainPage.photo.src = photoUrl || country.standardImage;
	Object.assign(mainPage, {name, id, surname, dob, sex, nationality, doi});
	const {print} = mainPage;
	switch (passportStatus) {
		case 1:
			if (print.textContent === 'Аннулировано')
				print.innerHTML = osisLogo;
			Object.assign(print.style, {
				visibility: 'visible',
				width: '130px',
				transform: 'rotate(-90deg) translate(100%, 400%)',
			});
			break;
		case -1:
			print.textContent = 'Аннулировано';
			Object.assign(print.style, {
				visibility: 'visible',
				width: '90%',
				transform: 'rotate(-90deg) translateY(200%)',
			});
			break;
		default:
			print.style.visibility = 'hidden';
	};
	const f4 = document.getElementById('marriages');
	f4.innerHTML = '';
	if (!marriages) return;
	for (let i = 0; i < marriages.length; i++) {
		const [date, name, divorceDate] = marriages[i];
		const divorce = divorceDate
			? `<div class='divorce'> Расторгнут ${divorceDate} </div>`
			: '';
		f4.innerHTML += `
		<div class='card'>
			<div class='data'>
				<span>${name}</span>
				<span class='date'>${date}</span>
			</div>
			${divorce}
		</div>`;
	};
}

function changeColor(currRGB, final, animDuration = 1000, animFrames = 60) {
	clearInterval(colorChanging);

	const curr = currRGB.match(/\d+/g).map(Number);
	const arr = Array(3);
	for (let i = 0; i < 3; i++)
		arr[i] = (curr[i]-final[i])/animFrames;

	const finalRGB = `rgb(${final})`;
	const {round} = Math;
	const {changeQRColor, stopQRColorChanging} = qr.startColorChanging();
	colorChanging = setInterval(() => {
		for (let i = 0; i < 3; i++) curr[i] -= arr[i];
		currRGB = `rgb(${curr.map(num => round(num))})`;
		body.style.setProperty('--p_color', currRGB);
		changeQRColor(currRGB);
		if (currRGB === finalRGB) {
			stopQRColorChanging();
			clearInterval(colorChanging);
		}
	}, animDuration/animFrames);
}

function openBook() {
	book.style.transform = 'translateX(50%)';
	transformBtns(180);
	prevBtn.style.visibility = nextBtn.style.visibility = 'visible';
	prevBtn.style.opacity = nextBtn.style.opacity = 100;
}

function closeBook() {
	let btn;
	if (currLoc === 2) {
		book.style.transform = 'translateX(0)';
		btn = prevBtn;
	} else {
		book.style.transform = 'translateX(100%)';
		btn = nextBtn;
	};
	btn.style.opacity = 0;
	setTimeout(() => {
		if (btn.style.opacity === '0') btn.style.visibility = 'hidden';
	}, 250);
	transformBtns(0);
}

const pageController = {
	_lastPageFrontId: 'f4',
	_firstPageBackId: 'b2',
	_isFlipping: false,
	_nextParams: {
		isShadowPage(id) {return id === this._firstPageBackId},
		getIndex: () => currLoc - spreads.length,
		handleBook: [openBook, closeBook],
	},
	_prevParams: {
		isShadowPage(id) {return id === this._lastPageFrontId},
		getIndex: () => spreads.length - i,
		handleBook: [closeBook, openBook]
	},
	next() {
		if (currLoc === maxLoc) return;
		if (this._flip(true, this._nextParams))
			currLoc++;
	},
	prev() {
		if (currLoc === 1) return;
		if (this._flip(false, this._prevParams))
			currLoc--;
	},
	_flip(isNext, {handleBook, isShadowPage, getIndex}) {
		if (this._isFlipping) return false;
		this._isFlipping = true;

		i = currLoc + isNext - 2;
		const spread = spreads[i];
		const {isCover, isFirst} = spread;
		spread.classList.toggle('flipped');
		if (isCover) {
			if (isFirst) handleBook[0]();
			else handleBook[1]();
		} else if (spread.isExtreme) {
			const id = isFirst ? this._firstPageBackId : this._lastPageFrontId;
			const paper = document.getElementById(id).querySelector('.paper');
			paper.style.boxShadow = 'none';
			if (isShadowPage(id)) setTimeout(() => {
				const sign = isFirst ? '-' : '';
				paper.style.boxShadow = sign + '5px 0 5px #0005';
			}, 250);
		};
		setTimeout(() => {
			spread.style.zIndex =
			spread.querySelector('.front').style.zIndex =
				getIndex();
		}, isNext*250);
		setTimeout(() => {
			this._isFlipping = false
		}, 250);
		return true;
	}
};

function rotateBook() {
	const isMaxLoc = currLoc === maxLoc;
	const isMinLoc = currLoc === 1;
	if (book.style.transform.indexOf('rotate') === -1) {
		book.style.transform = `rotate(90deg) translateX(${isMaxLoc ? 120 : 20}%)`;
		transformBtns(80);
		return;
	};
	book.style.transform = `translateX(${isMinLoc ? 0 : isMaxLoc ? 100 : 50}%)`;
	transformBtns(isMinLoc || isMaxLoc ? 0 : 180);
}

// Listeners
book.addEventListener('click', ({target: el}) => {
	if (el.closest('#qr'))
		navigator.clipboard.writeText(location.href);
	else if (el.closest('.front'))
		pageController.next();
	else
		pageController.prev();
});
prevBtn.addEventListener('click', () => pageController.prev());
nextBtn.addEventListener('click', () => pageController.next());
rotateBtn.addEventListener('click', rotateBook);
idBtn.addEventListener('click', getPassport);
const keyEvents = {
	ArrowRight() {pageController.next()},
	ArrowLeft() {pageController.prev()}
};
document.addEventListener('keydown', ({key}) => {
	if (getSelection().anchorNode === idForm) return;
	if (+key) idInput.select();
	else keyEvents[key]?.();
});
idInput.addEventListener('keydown', e => e.key === 'Enter' && getPassport());
idInput.addEventListener('input', ({target: el}) => {
	el.value = +el.value > el.max
		? el.max
		: el.value.replace(/^[-0]+/g, '');
});