(()=>{fetch("https://script.google.com/macros/s/AKfycbybniugM8wK3-QLOPQ51AJ6jgHrZOfTJ6JSmXDMoT3T8AA3YSLTsVh1893t62zhQTJlFA/exec").then(t=>t.json()).then(({response:t})=>{passports=t,body.classList.remove("loading"),idInput.max=passports.length,currPassportId&&(idInput.value=currPassportId,doQRColorTransition=!1,toHtml(passports[currPassportId-1])),console.log("Passports have been loaded")});let passports,currCountry,colorChanging,doQRColorTransition,currPassportId=+location.search.split("id=")[1]||null,currLoc=1;const{protocol,host,pathname}=location,BASE_URL=protocol+"//"+host+pathname,FILES_PATH="./files/",DEFAULT_COLOR="rgb(135, 135, 135)",getPassportUrl=t=>BASE_URL+(t?"?id="+t:""),$=t=>document.getElementById(t),transformBtns=t=>{prevBtn.style.transform=`translateX(-${t}px)`,nextBtn.style.transform=`translateX(${t}px)`},body=document["body"],spreads=Array.from(body.querySelectorAll(".spread")),rotateBtn=$("rotate-btn"),prevBtn=$("prev"),nextBtn=$("next"),idBtn=$("id-btn"),idForm=$("id-form"),idInput=$("id-input"),book=$("book"),osisLogo=$("osis"),createGetter=r=>({get:(t,e)=>t.querySelector(r+e)}),proxyDOM=t=>new Proxy(t,{set:(t,e,r)=>t[e].textContent=r}),u=new Proxy($("f3"),createGetter("#u_")),mainPage=proxyDOM({name:u.name,flagCont:u["flag-container"],flag:u.flag,country:u.country,photo:u.photo,id:u.id,surname:u.surname,dob:u.DoB,doi:u.DoI,sex:u.sex,nationality:u.nationality,stamp:u.stamp}),cah=new Proxy($("country_and_herb"),createGetter("#")),frontCover=proxyDOM({countryName:cah["country-name"],herb:cah.herb}),countries=[["gsld","#332266","Республика Гусляндия","goose.svg"],["ngld","#55bb33","Республика Неогусляндия","goose.svg"],["duck","#ee8844","Утиное Государство","duck.png"]].map(([t,e,r,o])=>({code:t,name:r,colorHEX:e,color:e.slice(1).match(/../g).map(t=>parseInt(t,16)),dir:FILES_PATH+t+"/",standardImage:FILES_PATH+"standard-image/"+o})),qr=Object.assign(new QRCode($("qr"),{text:getPassportUrl(currPassportId),width:256,height:256,colorDark:DEFAULT_COLOR,colorLight:"#00000000",correctLevel:QRCode.CorrectLevel.L}),{startColorChanging(){this._oDrawing._elCanvas.style.display="unset",this._oDrawing._elImage.style.display="none"},changeColor(t){this._htOption.colorDark=t,this._oDrawing.draw(this._oQRCode)},stopColorChanging(){this.makeImage()}});for(let t=0;t<spreads.length;t++)spreads[t].style.zIndex=spreads.length-t;body.style.setProperty("--p_color",DEFAULT_COLOR);const[lSpread,plSpread]=spreads.reverse(),[fSpread,sSpread]=spreads.reverse(),maxLoc=(fSpread.isCover=fSpread.isFirst=lSpread.isCover=sSpread.isExtreme=sSpread.isFirst=plSpread.isExtreme=!0,spreads.length+1);function getPassport(){var t=+idInput.value;0<t&&t!==currPassportId&&(currPassportId=t,history.pushState({id:currPassportId},null,getPassportUrl(currPassportId)),qr.makeCode(getPassportUrl(currPassportId)),toHtml(passports[currPassportId-1]))}function toHtml(t){const[e,r,o,s,a,n,i,l,d,c,p]=t,g=countries[s];var u;currCountry!==g&&(t={[g.code.toUpperCase()]:!0},u=g.dir+"/herb.svg",frontCover.countryName.style.fontSize=(t.NGLD?"20":"24")+"px",frontCover.countryName=g.name,frontCover.herb.src=u,changeColor(getComputedStyle(body).getPropertyValue("--p_color"),g.color),book.style.setProperty("--herb_url",`url(${u})`),currCountry=g,mainPage.flagCont.style=t.DUCK?"text-align: center; background: #8ce; width: 80%":"text-align: none; background: none; width: none",Object.assign(mainPage.flag,{src:t.DUCK?u:g.dir+"/flag.svg",style:"float: "+(t.DUCK?"none":"left")}),mainPage.country=g.name),mainPage.photo.src=d||g.standardImage,Object.assign(mainPage,{name:e,id:n,surname:r,dob:i,sex:o,nationality:a,doi:l});const m=mainPage["stamp"];switch(c){case 1:"Аннулировано"===m.textContent&&(m.innerHTML=osisLogo.innerHTML),Object.assign(m.style,{visibility:"visible",width:"130px",transform:"rotate(-90deg) translate(100%, 400%)"});break;case-1:m.textContent="Аннулировано",Object.assign(m.style,{visibility:"visible",width:"90%",transform:"rotate(-90deg) translateY(200%)"});break;default:m.style.visibility="hidden"}const y=document.getElementById("marriages");if(y.innerHTML="",p)for(let t=0;t<p.length;t++){const[h,e,v]=p[t];y.innerHTML+=`
		<div class='card'>
			<div class='data'>
				<span>${e}</span>
				<span class='date'>${h}</span>
			</div>
			${v?`<div class='divorce'> Расторгнут ${v} </div>`:""}
		</div>`}}function changeColor(t,e,r=1e3,o=60){clearInterval(colorChanging);const s=t.match(/\d+/g).map(Number),a=Array(3);for(let t=0;t<3;t++)a[t]=(s[t]-e[t])/o;const n=`rgb(${e})`,i=Math["round"];qr.startColorChanging(),doQRColorTransition||(qr.changeColor(n),qr.stopColorChanging()),colorChanging=setInterval(()=>{for(let t=0;t<3;t++)s[t]-=a[t];t=`rgb(${s.map(t=>i(t))})`,body.style.setProperty("--p_color",t),doQRColorTransition&&qr.changeColor(t),t===n&&(doQRColorTransition?qr.stopColorChanging():doQRColorTransition=!0,clearInterval(colorChanging))},r/o)}function openBook(){book.style.transform="translateX(50%)",transformBtns(180),prevBtn.style.visibility=nextBtn.style.visibility="visible",prevBtn.style.opacity=nextBtn.style.opacity=100}function closeBook(){let t;(t=2===currLoc?(book.style.transform="translateX(0)",prevBtn):(book.style.transform="translateX(100%)",nextBtn)).style.opacity=0,setTimeout(()=>{"0"===t.style.opacity&&(t.style.visibility="hidden")},250),transformBtns(0)}onpopstate=({state:t})=>{t=t?.id||!1;t?(idInput.value=currPassportId=t,toHtml(passports[t-1])):location.reload()};const pageController={_lastPageFrontId:"f4",_firstPageBackId:"b2",_isFlipping:!(mainPage.photo.onerror=({target:t})=>t.src=currCountry.standardImage),_nextParams:{isShadowPage(t){return t===this._firstPageBackId},getIndex:()=>currLoc-spreads.length,handleBook:[openBook,closeBook]},_prevParams:{isShadowPage(t){return t===this._lastPageFrontId},getIndex:()=>spreads.length-i,handleBook:[closeBook,openBook]},next(){currLoc!==maxLoc&&this._flip(!0,this._nextParams)&&currLoc++},prev(){1!==currLoc&&this._flip(!1,this._prevParams)&&currLoc--},_flip(t,{handleBook:e,isShadowPage:r,getIndex:o}){if(this._isFlipping)return!1;this._isFlipping=!0,i=currLoc+t-2;const s=spreads[i],{isCover:a,isFirst:n}=s;if(s.classList.toggle("flipped"),a)n?e[0]():e[1]();else if(s.isExtreme){e=n?this._firstPageBackId:this._lastPageFrontId;const l=document.getElementById(e).querySelector(".paper");l.style.boxShadow="none",r(e)&&setTimeout(()=>{var t=n?"-":"";l.style.boxShadow=t+"5px 0 5px #0005"},250)}return setTimeout(()=>{s.style.zIndex=s.querySelector(".front").style.zIndex=o()},250*t),setTimeout(()=>{this._isFlipping=!1},250),!0}};function rotateBook(){var t=currLoc===maxLoc,e=1===currLoc;-1===book.style.transform.indexOf("rotate")?(book.style.transform=`rotate(90deg) translateX(${t?120:20}%)`,transformBtns(80)):(book.style.transform=`translateX(${e?0:t?100:50}%)`,transformBtns(e||t?0:180))}book.addEventListener("click",({target:t})=>{t.closest("#qr")?navigator.clipboard.writeText(location.href):t.closest(".front")?pageController.next():pageController.prev()}),prevBtn.addEventListener("click",()=>pageController.prev()),nextBtn.addEventListener("click",()=>pageController.next()),rotateBtn.addEventListener("click",rotateBook),idBtn.addEventListener("click",getPassport);const keyEvents={ArrowRight(){pageController.next()},ArrowLeft(){pageController.prev()}};document.addEventListener("keydown",({key:t})=>{getSelection().anchorNode!==idForm&&(+t?idInput.select():keyEvents[t]?.())}),idInput.addEventListener("keydown",t=>"Enter"===t.key&&getPassport()),idInput.addEventListener("input",({target:t})=>{t.value=+t.value>t.max?t.max:t.value.replace(/^[-0]+/g,"")});})()